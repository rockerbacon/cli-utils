#!/usr/bin/env python3

from json import JSONDecoder
from subprocess import DEVNULL, PIPE, Popen

# modes=$(makoctl mode)
#
# if [[ "$modes" =~ 'notif-center' ]]; then
# 	makoctl dismiss -a
# 	makoctl mode -r 'notif-center' >/dev/null
# 	exit 0
# fi
#
# if [[ "$modes" =~ 'do-not-disturb' ]]; then
# 	makoctl mode -r 'do-not-disturb' >/dev/null
# fi
#
# makoctl mode -a 'notif-center' >/dev/null
# # TODO replay notifications from history
# # makoctl restore
# # for i in {1..10}; do 
# # 	makoctl restore
# # done

def makoctl(*args, stdout=DEVNULL):
	cmdline = ["makoctl"]
	for a in args:
		cmdline.append(a)

	prog = Popen(cmdline, stdout=stdout)
	if stdout == DEVNULL:
		prog.wait()

	return prog

def list_modes():
	cmd = makoctl("mode", stdout=PIPE)
	return [x[:-1].decode('utf-8') for x in cmd.stdout];

def main():
	modes = list_modes()

	makoctl("dismiss", "-a")

	if "notif-center" in modes:
		makoctl("mode", "-r", "notif-center")
		return

	makoctl("mode", "-a", "notif-center")
	
	history = JSONDecoder().decode(
		makoctl("history", stdout=PIPE).stdout.read().decode('utf-8')
	)

	# print(history)
	for notif in history["data"][0][-10:]:
		cmdline = [
			"notify-send",
			"--replace-id",
			str(notif["id"]["data"])
		]

		if notif["app-icon"]["data"]:
			cmdline.append("--icon")
			cmdline.append(notif["app-icon"]["data"])

		cmdline.append(notif["summary"]["data"])
		if notif["body"]["data"]:
			cmdline.append(notif["body"]["data"])

		Popen(cmdline).wait()

if __name__ == '__main__':
	main()
